<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= post.title %> - Purpose & Perspective</title>
    <link rel="stylesheet" href="/styles/main.css"> 
    
</head>
<body>
    <%- include("partials/header") %>

<div class="post-card">
  <h2><%= post.title %></h2>
  <div class="post-meta" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
    <% if (post.authorName) { %>
      <p style="margin: 0; color: #666; font-size: 0.9rem;">
        👤 By <strong><%= post.authorName %></strong> • 
        📅 <%= new Date(post.createdAt).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        }) %>
        <% if (post.category) { %> • 🏷️ <%= post.category %><% } %>
      </p>
    <% } %>
  </div>
  <p><%= post.body %></p>
  
  <div class="post-actions">
    <a href="/" class="back-button">
      <svg style="width: 1rem; height: 1rem; display: inline-block; vertical-align: middle; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to Home
    </a>
    
    <div class="action-buttons">
      <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated && typeof user !== 'undefined' && 
             (user.role === 'admin' || (post.author && post.author.toString() === user.id))) { %>
        <a href="/posts/<%= post._id %>/edit">
          <button class="edit-button">Edit</button>
        </a>
        <form action="/posts/<%= post._id %>/delete" method="POST" style="display:inline;">
          <button type="submit" onclick="return confirm('Are you sure you want to delete this post?')">Delete</button>
        </form>
      <% } %>
    </div>
  </div>

</div>

<!-- Comments Section -->
<div class="comments-section" id="comments">
  <h3>💬 Comments</h3>
  
  <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
    <!-- Add Comment Form -->
    <div class="add-comment-form">
      <form action="/posts/<%= post._id %>/comment" method="POST">
        <div class="form-group">
          <label for="comment">Add your comment:</label>
          <textarea 
            id="comment" 
            name="comment" 
            rows="4" 
            placeholder="Share your thoughts on this post..." 
            required 
            maxlength="1000"
          ></textarea>
          <small class="char-counter">0/1000 characters</small>
        </div>
        <button type="submit" class="comment-submit-btn">Post Comment</button>
      </form>
    </div>
  <% } else { %>
    <div class="login-prompt">
      <p>Please <a href="/login">login</a> to add comments.</p>
    </div>
  <% } %>
  
  <!-- Comments Display -->
  <div class="comments-list">
    <div id="comments-container">
      <!-- Comments will be loaded here -->
      <div class="loading-comments">Loading comments...</div>
    </div>
  </div>
</div>

<script>
// Character counter for comment textarea
const commentTextarea = document.getElementById('comment');
const charCounter = document.querySelector('.char-counter');

if (commentTextarea && charCounter) {
  commentTextarea.addEventListener('input', function() {
    const count = this.value.length;
    charCounter.textContent = `${count}/1000 characters`;
    
    if (count > 800) {
      charCounter.style.color = '#dc3545';
    } else if (count > 600) {
      charCounter.style.color = '#ffc107';
    } else {
      charCounter.style.color = '#6c757d';
    }
  });
}

// Load comments when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadComments();
});

async function loadComments() {
  try {
    const response = await fetch('/posts/<%= post._id %>/comments');
    const comments = await response.json();
    
    const container = document.getElementById('comments-container');
    
    if (comments.length === 0) {
      container.innerHTML = '<div class="no-comments">No comments yet. Be the first to share your thoughts!</div>';
      return;
    }
    
    container.innerHTML = comments.map(comment => `
      <div class="comment-item">
        <div class="comment-header">
          <strong class="comment-author">👤 ${comment.author.username}</strong>
          <span class="comment-date">${new Date(comment.createdAt).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })}</span>
        </div>
        <div class="comment-content">${comment.content}</div>
      </div>
    `).join('');
  } catch (error) {
    console.error('Error loading comments:', error);
    document.getElementById('comments-container').innerHTML = '<div class="error-message">Error loading comments.</div>';
  }
}
</script>



<%- include("partials/footer") %>
</body>
</html>