<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Reflection - Purpose & Perspective</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <%- include("partials/header") %>

    <% if (typeof post !== 'undefined' && post) { %>
      <form action="/posts/<%= post._id %>/edit" method="POST" enctype="multipart/form-data" class="post-card compose-form">
        <h2>‚úèÔ∏è Edit Reflection</h2>
        
        <!-- Title -->
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="<%= post.title %>" required>
        </div>

        <!-- Category -->
        <div class="form-group">
            <label for="category">Category</label>
            <select id="categorySelect" name="category" required>
                <option value="Daily Reflections" <%= (post.category === 'Daily Reflections' || !post.category) ? 'selected' : '' %>>Daily Reflections</option>
                <option value="Personal Growth" <%= (post.category === 'Personal Growth') ? 'selected' : '' %>>Personal Growth</option>
                <% if (typeof categories !== 'undefined' && categories.length > 0) { %>
                    <% categories.forEach(cat => { %>
                        <% if (cat !== 'Daily Reflections' && cat !== 'Personal Growth') { %>
                            <option value="<%= cat %>" <%= (post.category === cat) ? 'selected' : '' %>><%= cat %></option>
                        <% } %>
                    <% }); %>
                <% } %>
                <option value="__new__">+ Create New Category</option>
            </select>
            
            <!-- Hidden input for custom category -->
            <div id="customCategoryGroup" class="form-group" style="display: none; margin-top: 0.5rem;">
                <input type="text" id="customCategory" placeholder="Enter new category name..." 
                       style="margin-top: 0.5rem;">
                <button type="button" id="addCategoryBtn" class="btn-secondary" style="margin-top: 0.5rem;">Add Category</button>
                <button type="button" id="cancelCategoryBtn" class="btn-secondary" style="margin-top: 0.5rem;">Cancel</button>
            </div>
            
            <small class="form-hint">üí° Select an existing category or create a new one</small>
        </div>

        <!-- Current Image Display -->
        <% if (post.featuredImage) { %>
        <div class="form-group">
            <label>Current Image:</label>
            <div class="current-image">
                <img src="<%= post.featuredImage %>" alt="Current featured image" style="max-width: 200px; max-height: 150px; object-fit: cover; border-radius: 8px;">
            </div>
        </div>
        <% } %>

        <!-- Image Options -->
        <div class="form-group">
            <label>Featured Image (Optional)</label>
            <div class="image-options">
                <div class="option-buttons">
                    <button type="button" class="option-btn active" data-option="url">üîó Image URL</button>
                    <button type="button" class="option-btn" data-option="upload">üìÅ Upload File</button>
                </div>
                
                <div class="image-input url-input">
                    <input type="url" id="featuredImage" name="featuredImage" 
                           placeholder="https://example.com/image.jpg" 
                           value="<%= post.featuredImage && !post.featuredImage.startsWith('/uploads/') ? post.featuredImage : '' %>">
                    <small class="form-hint">üñºÔ∏è Enter an image URL</small>
                </div>
                
                <div class="image-input upload-input" style="display: none;">
                    <input type="file" id="imageFile" name="imageFile" accept="image/*">
                    <small class="form-hint">üìé Choose an image file (max 5MB)</small>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="form-group">
            <label for="body">Content</label>
            <textarea id="body" name="body" rows="8" placeholder="Share your thoughts..." required><%= post.body %></textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="submit-button">üíæ Update Reflection</button>
            <a href="/posts/<%= post._id %>" class="cancel-button">Cancel</a>
            <a href="/" class="back-button">
              <svg style="width: 1rem; height: 1rem; display: inline-block; vertical-align: middle; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              Home
            </a>
        </div>
      </form>

      <script>
        // Image option toggle functionality
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                // Hide all input types
                document.querySelectorAll('.image-input').forEach(input => input.style.display = 'none');
                
                // Show selected input type
                const option = this.dataset.option;
                document.querySelector(`.${option}-input`).style.display = 'block';
            });
        });

        // Category dropdown functionality
        const categorySelect = document.getElementById('categorySelect');
        const customCategoryGroup = document.getElementById('customCategoryGroup');
        const customCategoryInput = document.getElementById('customCategory');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');

        if (categorySelect && customCategoryGroup) {
            categorySelect.addEventListener('change', function() {
                if (this.value === '__new__') {
                    customCategoryGroup.style.display = 'block';
                    customCategoryInput.focus();
                } else {
                    customCategoryGroup.style.display = 'none';
                }
            });

            addCategoryBtn.addEventListener('click', function() {
                const newCategory = customCategoryInput.value.trim();
                if (newCategory) {
                    // Add new option to select (before the "Create New" option)
                    const newOption = document.createElement('option');
                    newOption.value = newCategory;
                    newOption.textContent = newCategory;
                    newOption.selected = true;
                    
                    // Insert before the last option (Create New Category)
                    const lastOption = categorySelect.lastElementChild;
                    categorySelect.insertBefore(newOption, lastOption);
                    
                    // Hide the custom input
                    customCategoryGroup.style.display = 'none';
                    customCategoryInput.value = '';
                }
            });

            cancelCategoryBtn.addEventListener('click', function() {
                customCategoryGroup.style.display = 'none';
                customCategoryInput.value = '';
                // Reset to original category
                const originalCategory = '<%= post.category || "Daily Reflections" %>';
                for (let option of categorySelect.options) {
                    if (option.value === originalCategory) {
                        option.selected = true;
                        break;
                    }
                }
            });

            // Allow Enter key to add category
            customCategoryInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCategoryBtn.click();
                }
            });
        }
      </script>
    <% } else { %>
      <div class="post-card">
        <h2>Post not found</h2>
        <p>The post you are trying to edit does not exist.</p>
      </div>
    <% } %>

    <%- include("partials/footer") %>
</body>
</html>